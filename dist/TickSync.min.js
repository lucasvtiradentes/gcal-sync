class TickSync{constructor(e){this.parseConfigs(e),this.config=e}parseConfigs(e){["synchronization","summary","options"].forEach((t=>{if(!Object.keys(e).includes(t))throw new Error(`missing key in configs: ${t}`)}))}getBetween(e,t,n){const s=e.slice(e.search(t)).replace(t,"");return s.slice(0,s.search(n))}getParsedTimeStamp(e){const t=e.split("T");return{year:t[0].substring(0,4),month:t[0].substring(4,6),day:t[0].substring(6,8),hours:t[1]?t[1].substring(0,2):"00",minutes:t[1]?t[1].substring(2,4):"00",seconds:t[1]?t[1].substring(4,6):"00"}}parseIcsStringIntoEvents(e){return e.split("BEGIN:VEVENT\r\n").filter((e=>e.search("SUMMARY")>-1)).reduce(((e,t)=>{const n=this.getBetween(t,"TZID:","\r\n");let s=this.getBetween(t,"DTSTART;","\r\n");s=s.slice(s.search(":")+1);let i=this.getBetween(t,"DTEND;","\r\n");if(i=i.slice(i.search(":")+1),""===i){const e=this.getParsedTimeStamp(s),t=new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0));t.setDate(t.getDate()+1),i={date:t.toISOString().split("T")[0]},s={date:`${e.year}-${e.month}-${e.day}`}}else{const e=this.getParsedTimeStamp(s),t=this.getParsedTimeStamp(i);s={dateTime:`${e.year}-${e.month}-${e.day}T${e.hours}:${e.minutes}:${e.seconds}-03:00`,timeZone:n},i={dateTime:`${t.year}-${t.month}-${t.day}T${t.hours}:${t.minutes}:${t.seconds}-03:00`,timeZone:n}}const r={id:this.getBetween(t,"UID:","\r\n"),name:this.getBetween(t,"SUMMARY:","\r\n"),description:this.getBetween(t,"DESCRIPTION:","\r\n"),tzid:n,start:s,end:i};return e.push(r),e}),[])}getEventsFromIcsCalendar(e,t){let n="";const s=e.replace("webcal://","https://"),i=UrlFetchApp.fetch(s,{validateHttpsCertificates:!1,muteHttpExceptions:!0});if(200!=i.getResponseCode())throw new Error("Error: Encountered HTTP error "+i.getResponseCode()+" when accessing "+s);if(n=i.getContentText(),-1===n.search("BEGIN:VCALENDAR"))throw new Error("[ERROR] Incorrect ics/ical URL: "+s);const r=this.parseIcsStringIntoEvents(n);return t?r.filter((e=>!1===t.some((t=>e.name.search(t)>-1)))):r}getAllCalendars(){return Calendar.CalendarList.list({showHidden:!0}).items}getCalendarByName(e){return this.getAllCalendars().find((t=>t.summary===e))}getEventsFromCalendar(e){return Calendar.Events.list(e.id,{}).items.map((e=>this.parseGoogleEvent(e)))}parseGoogleEvent(e){var t,n,s,i,r;return{id:e.id,summary:e.summary,description:null!==(t=e.description)&&void 0!==t?t:"",htmlLink:e.htmlLink,attendees:null!==(n=e.attendees)&&void 0!==n?n:[],visibility:null!==(s=e.visibility)&&void 0!==s?s:"default",reminders:null!==(i=e.reminders)&&void 0!==i?i:{},start:e.start,end:e.end,created:e.created,updated:e.updated,extendedProperties:null!==(r=e.extendedProperties)&&void 0!==r?r:{}}}getAllOwnedCalendars(){return Calendar.CalendarList.list({showHidden:!0}).items.filter((e=>"owner"===e.accessRole))}createCalendar(e){if(this.getAllOwnedCalendars().map((e=>e.summary)).includes(e))throw new Error(`calendar ${e} already exists!`);const t=Calendar.newCalendar();t.summary=e,t.timeZone=Calendar.Settings.get("timezone").value;return Calendar.Calendars.insert(t)}addEventToCalendar(e,t){return Calendar.Events.insert(t,e.id)}moveEventToOtherCalendar(e,t,n){Calendar.Events.move(e.id,t.id,n.id)}getEventById(e,t){return Calendar.Events.get(e.id,t)}updateEventFromCalendar(e,t,n){const s=this.getEventById(e,t.id),i=Object.assign(Object.assign({},s),n);Calendar.Events.update(i,e.id,t.id)}createCalendars(){[...new Set([...this.config.synchronization.icsCalendars.map((e=>e[1])),...this.config.synchronization.icsCalendars.map((e=>e[2]))])].forEach((e=>{this.getCalendarByName(e)||(this.createCalendar(e),this.config.options.showLogs&&console.log(`Created the calendar ${e}`))}))}shouldSendEmail(){const e=this.config.summary.timeToEmail.split(":"),t=60*Number(e[0])+Number(e[1]),n=new Date;n.setHours(n.getHours()+this.config.summary.timeZoneCorrection);return 60*Number(n.getHours())+Number(n.getMinutes())>=t}emailSummary(e){const t=e.addedEvents.length+e.updatedEvents.length+e.completedEvents.length;let n="";n=`TickSync made ${t} changes to your calendar:<br/><br/>\n`;const s=e.addedEvents.map((e=>`<li>${e}</li>`)),i=e.updatedEvents.map((e=>`<li>${e}</li>`)),r=e.completedEvents.map((e=>`<li>${e}</li>`));n+=s.length>0?`added events:<br/> \n <ul>\n${s.join("\n")}</ul>\n`:"",n+=i.length>0?`updated events:<br/> \n <ul>\n${i.join("\n")}</ul>\n`:"",n+=r.length>0?`completed events:<br/> \n <ul>\n${r.join("\n")}</ul>\n`:"",n+="If you want to share feedback, please contact us at <a href='https://github.com/lucasvtiradentes/ticktick-gcal-sync'>github</a>.";const a={to:this.config.summary.email,name:"TickSync bot",subject:`TickSync summary for ${(new Date).toLocaleString("pt-br").split(", ")[0]} - ${t} modifications`,htmlBody:n};MailApp.sendEmail(a),this.config.options.showLogs&&console.log(`summary email was sent to ${this.config.summary.email}`)}checkTicktickAddedAndUpdatedTasks(e,t,n){const[s,i,r,a]=e,o=[],d=[],c=this.getCalendarByName(i);return t.forEach((e=>{if(n.map((e=>e.extendedProperties.private.tickTaskId)).includes(e.id)){const t=n.find((t=>t.extendedProperties.private.tickTaskId===e.id)),s=e.name!==t.summary,i=e.description!==t.description,r=Object.keys(e.start).length!==Object.keys(t.start).length,a=e.start.date!==t.start.date,o=e.start.dateTime!==t.start.dateTime;if(s||i||r||a||o){const n={summary:e.name,description:e.description,start:e.start,end:e.end};if(this.config.options.maintanceMode||this.updateEventFromCalendar(c,t,n),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${c.summary} | ${e.name}`;d.push(t),console.log(`gcal event was updated  : ${t}`)}}}else{const t={private:{tickTaskId:e.id,calendar:i,completedCalendar:r}},n={summary:e.name,description:e.description,start:e.start,end:e.end,reminders:{useDefault:!0},extendedProperties:t};if(this.config.options.maintanceMode||this.addEventToCalendar(c,n),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${c.summary} | ${e.name}`;o.push(t),console.log(`added event to gcal     : ${t}`)}}})),[o,d]}checkCalendarCompletedTasks(e,t){const n=[];return e.filter((e=>e.extendedProperties.private.tickTaskId)).forEach((e=>{if(!t.map((e=>e.id)).includes(e.extendedProperties.private.tickTaskId)){const t=this.getCalendarByName(e.extendedProperties.private.calendar),s=this.getCalendarByName(e.extendedProperties.private.completedCalendar);if(this.config.options.maintanceMode||this.moveEventToOtherCalendar(t,e,s),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${e.extendedProperties.private.calendar} | ${e.summary}`;n.push(t),console.log(`gcal event was completed: ${t}`)}}})),n}setupTickSync(){const e=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.synchronization.syncFunction));e&&ScriptApp.deleteTrigger(e),ScriptApp.newTrigger(this.config.synchronization.syncFunction).timeBased().everyMinutes(this.config.synchronization.updateFrequency).create(),this.config.options.showLogs&&console.log(`setup TickSync to run ${this.config.synchronization.syncFunction} update every ${this.config.synchronization.updateFrequency} minutes`)}uninstallTickSync(){const e=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.synchronization.syncFunction));e&&(ScriptApp.deleteTrigger(e),this.config.options.showLogs&&console.log("TickSync looping funtion trigger was removed!"))}cleanTodayEventsStats(){const e=PropertiesService.getScriptProperties();e.setProperty("addedEvents",""),e.setProperty("updatedEvents",""),e.setProperty("completedEvents",""),this.config.options.showLogs&&console.log(`${(new Date).toLocaleString("pt-br").split(", ")[0]} stats were reseted!`)}showTodayEventsStats(){const e=PropertiesService.getScriptProperties();console.log(`stats for ${(new Date).toLocaleString("pt-br").split(", ")[0]}`);const t=e=>e.split("\n").filter((e=>e.length>0)).map((e=>`- ${e}`)).join("\n"),n=e.getProperty("addedEvents"),s=e.getProperty("updatedEvents"),i=e.getProperty("completedEvents");console.log(`addedEvents: ${n.length}`,n.length>0?`\n\n${t(n)}`:""),console.log(`updatedEvents: ${n.length}`,s.length>0?`\n\n${t(s)}`:""),console.log(`completedEvents: ${n.length}`,i.length>0?`\n\n${t(i)}`:"")}getTasksFromGoogleCalendars(){return this.config.synchronization.icsCalendars.reduce(((e,t)=>{const n=t[1],s=this.getCalendarByName(n),i=this.getEventsFromCalendar(s);return e=[].concat.apply(e,i)}),[])}syncEvents(){const e={addedEvents:[],updatedEvents:[],completedEvents:[]};this.createCalendars();const t=this.getTasksFromGoogleCalendars(),n=[];if(this.config.synchronization.icsCalendars.forEach((s=>{const[i,r,a,o]=s,d=o?this.getEventsFromIcsCalendar(i,o):this.getEventsFromIcsCalendar(i);n.push(...d);const[c,l]=this.checkTicktickAddedAndUpdatedTasks(s,d,t);e.addedEvents.push(...c),e.updatedEvents.push(...l)})),e.completedEvents=this.checkCalendarCompletedTasks(t,n),this.config.options.showLogs&&(console.log(`addedEvents: ${e.addedEvents.length}`),console.log(`updatedEvents: ${e.updatedEvents.length}`),console.log(`completedEvents: ${e.completedEvents.length}`)),this.config.options.emailSummary&&!this.config.options.maintanceMode){const t=PropertiesService.getScriptProperties();t.getKeys().includes("addedEvents")||t.setProperties({addedEvents:"",updatedEvents:"",completedEvents:""});const n=e.addedEvents.length+e.updatedEvents.length+e.completedEvents.length,s=t.getProperty("addedEvents"),i=t.getProperty("updatedEvents"),r=t.getProperty("completedEvents");n>0&&(t.setProperty("addedEvents",`${s?s+"\n":""}${e.addedEvents.join("\n")}`),t.setProperty("updatedEvents",`${i?i+"\n":""}${e.updatedEvents.join("\n")}`),t.setProperty("completedEvents",`${r?r+"\n":""}${e.completedEvents.join("\n")}`),this.config.options.showLogs&&console.log("adding date stats to properties"));if(s.split("\n").filter((e=>e.length>0)).length+i.split("\n").filter((e=>e.length>0)).length+r.split("\n").filter((e=>e.length>0)).length>0&&this.shouldSendEmail()){const e={addedEvents:t.getProperty("addedEvents").split("\n").filter((e=>e.length>0)),updatedEvents:t.getProperty("updatedEvents").split("\n").filter((e=>e.length>0)),completedEvents:t.getProperty("completedEvents").split("\n").filter((e=>e.length>0))};this.emailSummary(e),this.cleanTodayEventsStats()}}}}