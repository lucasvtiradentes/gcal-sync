class TickSync{constructor(e){this.parseConfigs(e),this.config=e,this.githubRepository="lucasvtiradentes/ticktick-gcal-sync",this.version="0.0.1"}parseConfigs(e){["synchronization","notifications","options"].forEach((t=>{if(!Object.keys(e).includes(t))throw new Error(`missing key in configs: ${t}`)}))}getBetween(e,t,n){const s=e.slice(e.search(t)).replace(t,"");return s.slice(0,s.search(n))}getParsedTimeStamp(e){const t=e.split("T");return{year:t[0].substring(0,4),month:t[0].substring(4,6),day:t[0].substring(6,8),hours:t[1]?t[1].substring(0,2):"00",minutes:t[1]?t[1].substring(2,4):"00",seconds:t[1]?t[1].substring(4,6):"00"}}parseIcsStringIntoEvents(e){return e.split("BEGIN:VEVENT\r\n").filter((e=>e.search("SUMMARY")>-1)).reduce(((e,t)=>{const n=this.getBetween(t,"TZID:","\r\n");let s=this.getBetween(t,"DTSTART;","\r\n");s=s.slice(s.search(":")+1);let i=this.getBetween(t,"DTEND;","\r\n");if(i=i.slice(i.search(":")+1),""===i){const e=this.getParsedTimeStamp(s),t=new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0));t.setDate(t.getDate()+1),i={date:t.toISOString().split("T")[0]},s={date:`${e.year}-${e.month}-${e.day}`}}else{const e=this.getParsedTimeStamp(s),t=this.getParsedTimeStamp(i);s={dateTime:`${e.year}-${e.month}-${e.day}T${e.hours}:${e.minutes}:${e.seconds}-03:00`,timeZone:n},i={dateTime:`${t.year}-${t.month}-${t.day}T${t.hours}:${t.minutes}:${t.seconds}-03:00`,timeZone:n}}const a={id:this.getBetween(t,"UID:","\r\n"),name:this.getBetween(t,"SUMMARY:","\r\n"),description:this.getBetween(t,"DESCRIPTION:","\r\n"),tzid:n,start:s,end:i};return e.push(a),e}),[])}getEventsFromIcsCalendar(e){let t="";const n=e.replace("webcal://","https://"),s=UrlFetchApp.fetch(n,{validateHttpsCertificates:!1,muteHttpExceptions:!0});if(200!=s.getResponseCode())throw new Error("Error: Encountered HTTP error "+s.getResponseCode()+" when accessing "+n);if(t=s.getContentText(),-1===t.search("BEGIN:VCALENDAR"))throw new Error("[ERROR] Incorrect ics/ical URL: "+n);return t.search("SUMMARY:No task.")>0?[]:this.parseIcsStringIntoEvents(t)}getAllCalendars(){return Calendar.CalendarList.list({showHidden:!0}).items}getCalendarByName(e){return this.getAllCalendars().find((t=>t.summary===e))}getEventsFromCalendar(e){return Calendar.Events.list(e.id,{}).items.map((e=>this.parseGoogleEvent(e)))}parseGoogleEvent(e){var t,n,s,i,a;return{id:e.id,summary:e.summary,description:null!==(t=e.description)&&void 0!==t?t:"",htmlLink:e.htmlLink,attendees:null!==(n=e.attendees)&&void 0!==n?n:[],reminders:null!==(s=e.reminders)&&void 0!==s?s:{},visibility:null!==(i=e.visibility)&&void 0!==i?i:"default",start:e.start,end:e.end,created:e.created,updated:e.updated,extendedProperties:null!==(a=e.extendedProperties)&&void 0!==a?a:{}}}getAllOwnedCalendars(){return Calendar.CalendarList.list({showHidden:!0}).items.filter((e=>"owner"===e.accessRole))}createCalendar(e){if(this.getAllOwnedCalendars().map((e=>e.summary)).includes(e))throw new Error(`calendar ${e} already exists!`);const t=Calendar.newCalendar();t.summary=e,t.timeZone=Calendar.Settings.get("timezone").value;return Calendar.Calendars.insert(t)}addEventToCalendar(e,t){return Calendar.Events.insert(t,e.id)}moveEventToOtherCalendar(e,t,n){Calendar.Events.move(e.id,t.id,n.id)}getEventById(e,t){return Calendar.Events.get(e.id,t)}updateEventFromCalendar(e,t,n){const s=this.getEventById(e,t.id),i=Object.assign(Object.assign({},s),n);Calendar.Events.update(i,e.id,t.id)}createCalendars(){[...new Set([...this.config.synchronization.icsCalendars.map((e=>e[1])),...this.config.synchronization.icsCalendars.map((e=>e[2]))])].forEach((e=>{this.getCalendarByName(e)||(this.createCalendar(e),this.config.options.showLogs&&console.log(`Created google calendar: [${e}]`))}))}shouldSendEmail(){const e=this.config.notifications.timeToEmail.split(":"),t=60*Number(e[0])+Number(e[1]),n=new Date;n.setHours(n.getHours()+this.config.notifications.timeZoneCorrection);return 60*Number(n.getHours())+Number(n.getMinutes())>=t}formatSummary(e){if(""===e||!e)return"";const t=e.split("\n").map((e=>e.split(" | "))).sort(((e,t)=>Number(new Date(e[0]))-Number(new Date(t[0])))),n=Math.max(...t.map((e=>e[1].length)));return t.map((e=>{const[t,s,i]=e,a=n-s.length;return[t,0===a?s:s+"_".repeat(a),i]})).map((e=>e.join(" | "))).join("\n")}emailSummary(e){const t=e.addedEvents.length+e.updatedEvents.length+e.completedEvents.length,n=0===e.addedEvents.length?[]:this.formatSummary(e.addedEvents.join("\n")).split("\n"),s=0===e.updatedEvents.length?[]:this.formatSummary(e.updatedEvents.join("\n")).split("\n"),i=0===e.completedEvents.length?[]:this.formatSummary(e.completedEvents.join("\n")).split("\n");let a="";a=`TickSync made ${t} changes to your calendar:<br/><br/>\n`;const r=n.map((e=>`<li>${e}</li>`)),o=s.map((e=>`<li>${e}</li>`)),d=i.map((e=>`<li>${e}</li>`));a+=r.length>0?`added events: ${r.length}<br/> \n <ul>\n${r.join("\n")}</ul>\n`:"",a+=o.length>0?`updated events: ${o.length}<br/> \n <ul>\n${o.join("\n")}</ul>\n`:"",a+=d.length>0?`completed events: ${d.length}<br/> \n <ul>\n${d.join("\n")}</ul>\n`:"",a+=`If you want to share feedback, please contact us at <a href='https://github.com/${this.githubRepository}'>github</a>.`;const c={to:this.config.notifications.email,name:"TickSync bot",subject:`TickSync summary for ${(new Date).toLocaleString("pt-br").split(", ")[0]} - ${t} modifications`,htmlBody:a};MailApp.sendEmail(c),this.config.options.showLogs&&console.log(`summary email was sent to ${this.config.notifications.email}`)}checkTicktickAddedAndUpdatedTasks(e,t,n){const[s,i,a,r]=e,o=[],d=[],c=this.getCalendarByName(i);return t.forEach((e=>{if(n.map((e=>e.extendedProperties.private.tickTaskId)).includes(e.id)){const t=n.find((t=>t.extendedProperties.private.tickTaskId===e.id)),s=e.name!==t.summary,i=e.description!==t.description,a=Object.keys(e.start).length!==Object.keys(t.start).length,r=e.start.date!==t.start.date,o=e.start.dateTime!==t.start.dateTime;if(s||i||a||r||o){const n={summary:e.name,description:e.description,start:e.start,end:e.end};if(this.config.options.maintanceMode||this.updateEventFromCalendar(c,t,n),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${c.summary} | ${e.name}`;d.push(t),console.log(`gcal event was updated  : ${t}`)}}}else{const t={private:{tickTaskId:e.id,calendar:i,completedCalendar:a}},n={summary:e.name,description:e.description,start:e.start,end:e.end,reminders:{useDefault:!0},extendedProperties:t};if(this.config.options.maintanceMode||this.addEventToCalendar(c,n),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${c.summary} | ${e.name}`;o.push(t),console.log(`added event to gcal     : ${t}`)}}})),[o,d]}checkCalendarCompletedTasks(e,t){const n=[];return e.filter((e=>e.extendedProperties.private.tickTaskId)).forEach((e=>{if(!t.map((e=>e.id)).includes(e.extendedProperties.private.tickTaskId)){const t=this.getCalendarByName(e.extendedProperties.private.calendar),s=this.getCalendarByName(e.extendedProperties.private.completedCalendar);if(this.config.options.maintanceMode||this.moveEventToOtherCalendar(t,e,s),this.config.options.showLogs){const t=`${e.start.date?e.start.date:e.start.dateTime.split("T")[0]} | ${e.extendedProperties.private.calendar} | ${e.summary}`;n.push(t),console.log(`gcal event was completed: ${t}`)}}})),n}formatEventsList(e){return this.formatSummary(e.split("\n").filter((e=>e.length>0)).map((e=>`- ${e}`)).join("\n"))}checkCalendarItem(e,t,n){const[s,i,a,r]=e;let o=this.getEventsFromIcsCalendar(s);r.ignoredTags&&n&&r.ignoredTags.forEach((e=>{const t=n.find((t=>t.calendarOptions.tag===e));if(t){const e=t.tasksFromIcs.map((e=>e.id));o=o.filter((t=>!1===e.includes(t.id)))}}));const[d,c]=this.checkTicktickAddedAndUpdatedTasks(e,o,t);return{icsCal:s,gCalCorresponding:i,completedCal:a,calendarOptions:r,tasksFromIcs:o,addedTasks:d,updatedTasks:c}}getTasksFromGoogleCalendars(){return this.config.synchronization.icsCalendars.reduce(((e,t)=>{const n=t[1],s=this.getCalendarByName(n),i=this.getEventsFromCalendar(s);return e=[].concat.apply(e,i)}),[])}installTickSync(){const e=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.synchronization.syncFunction));e&&ScriptApp.deleteTrigger(e),ScriptApp.newTrigger(this.config.synchronization.syncFunction).timeBased().everyMinutes(this.config.synchronization.updateFrequency).create(),this.config.options.showLogs&&console.log(`setup TickSync to run ${this.config.synchronization.syncFunction} update every ${this.config.synchronization.updateFrequency} minutes`)}uninstallTickSync(){const e=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.synchronization.syncFunction));e&&(ScriptApp.deleteTrigger(e),this.config.options.showLogs&&console.log("TickSync looping funtion trigger was removed!"))}cleanTodayEventsStats(){const e=PropertiesService.getScriptProperties();e.setProperty("addedEvents",""),e.setProperty("updatedEvents",""),e.setProperty("completedEvents",""),this.config.options.showLogs&&console.log(`${(new Date).toLocaleString("pt-br").split(", ")[0]} stats were reseted!`)}showTodayEventsStats(){const e=PropertiesService.getScriptProperties(),t=e=>e.split("\n").filter((e=>e.length>0));console.log(`stats for ${(new Date).toLocaleString("pt-br").split(", ")[0]}`);const n=e.getProperty("addedEvents"),s=e.getProperty("updatedEvents"),i=e.getProperty("completedEvents");console.log(`addedEvents: ${t(n).length}`,t(n).length>0?`\n\n${this.formatEventsList(n)}`:""),console.log(`updatedEvents: ${t(s).length}`,t(s).length>0?`\n\n${this.formatEventsList(s)}`:""),console.log(`completedEvents: ${t(i).length}`,t(i).length>0?`\n\n${this.formatEventsList(i)}`:"")}checkForUpdate(){var e;const t=null!==(e=PropertiesService.getScriptProperties().getProperty("oldAlertedVersion"))&&void 0!==e?e:"",n=e=>Number(e.replace("v","").split(".").join("")),s=UrlFetchApp.fetch(`https://api.github.com/repos/${this.githubRepository}/releases?per_page=1`),i=JSON.parse(s.getContentText())[0],a=n(i.tag_name);if(a>n(this.version)&&a.toString()!=t){const e=`Hi!\n      <br/><br/>\n      a new <a href="https://github.com/${this.githubRepository}">ticktick-gcal-sync</a> version is available: <br/>\n      <ul>\n        <li>new version: ${i.tag_name}</li>\n        <li>published at: ${i.published_at}</li>\n      </ul>\n      you can check details <a href="https://github.com/${this.githubRepository}/releases">here</a>.\n      `,t={to:this.config.notifications.email,name:"TickSync bot",subject:`new ticktick-gcal-sync version [${i.tag_name}] was released!`,htmlBody:e};MailApp.sendEmail(t),PropertiesService.getScriptProperties().setProperty("oldAlertedVersion",a.toString()),this.config.options.showLogs&&console.log(`a new release email was sent to ${this.config.notifications.email}`)}}syncEvents(){const e={addedEvents:[],updatedEvents:[],completedEvents:[]};this.createCalendars();const t=this.getTasksFromGoogleCalendars(),n=this.config.synchronization.icsCalendars.filter((e=>{var t;return"string"==typeof(null===(t=e[3])||void 0===t?void 0:t.tag)})).map((e=>this.checkCalendarItem(e,t))),s=n.reduce(((e,t)=>(e.added||(e.added=[],e.updated=[],e.taggedIcsTasks=[]),e.added.push(...t.addedTasks),e.updated.push(...t.updatedTasks),e.taggedIcsTasks.push(...t.tasksFromIcs),e)),{});e.addedEvents.push(...s.added),e.updatedEvents.push(...s.updated);const i=this.config.synchronization.icsCalendars.filter((e=>!e[3]||e[3]&&!e[3].tag)).map((e=>this.checkCalendarItem(e,t,n))).reduce(((e,t)=>(e.added||(e.added=[],e.updated=[],e.taggedIcsTasks=[]),e.added.push(...t.addedTasks),e.updated.push(...t.updatedTasks),e.taggedIcsTasks.push(...t.tasksFromIcs),e)),{});e.addedEvents.push(...i.added),e.updatedEvents.push(...i.updated);const a=[...s.taggedIcsTasks,...i.taggedIcsTasks];if(e.completedEvents=this.checkCalendarCompletedTasks(t,a),this.config.options.showLogs&&(console.log(`addedEvents: ${e.addedEvents.length}`),console.log(`updatedEvents: ${e.updatedEvents.length}`),console.log(`completedEvents: ${e.completedEvents.length}`)),this.config.notifications.emailSummary&&!this.config.options.maintanceMode){const t=PropertiesService.getScriptProperties();t.getKeys().includes("addedEvents")||t.setProperties({addedEvents:"",updatedEvents:"",completedEvents:""});const n=e.addedEvents.length+e.updatedEvents.length+e.completedEvents.length,s=t.getProperty("addedEvents"),i=t.getProperty("updatedEvents"),a=t.getProperty("completedEvents");if(n>0&&(t.setProperty("addedEvents",`${s?s+"\n":""}${e.addedEvents.join("\n")}`),t.setProperty("updatedEvents",`${i?i+"\n":""}${e.updatedEvents.join("\n")}`),t.setProperty("completedEvents",`${a?a+"\n":""}${e.completedEvents.join("\n")}`),this.config.options.showLogs&&console.log("adding date stats to properties")),this.shouldSendEmail()){if(s.split("\n").filter((e=>e.length>0)).length+i.split("\n").filter((e=>e.length>0)).length+a.split("\n").filter((e=>e.length>0)).length>0){const e={addedEvents:t.getProperty("addedEvents").split("\n").filter((e=>e.length>0)),updatedEvents:t.getProperty("updatedEvents").split("\n").filter((e=>e.length>0)),completedEvents:t.getProperty("completedEvents").split("\n").filter((e=>e.length>0))};this.emailSummary(e),this.cleanTodayEventsStats()}this.config.notifications.emailNewRelease&&this.checkForUpdate()}}}}