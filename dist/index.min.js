!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).GcalSync=t()}(this,(function(){"use strict";function e(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function t(e){const t=PropertiesService.getScriptProperties().getProperty(e);let i;try{i=JSON.parse(t)}catch(e){i=t}return i}function i(e,t){const i="string"==typeof t?t:JSON.stringify(t);PropertiesService.getScriptProperties().setProperty(e,i)}function n(e){const t=ScriptApp.getProjectTriggers().find((t=>t.getHandlerFunction()===e));t&&ScriptApp.deleteTrigger(t)}"function"==typeof SuppressedError&&SuppressedError;const s={DEBUG_MODE:!0,MAX_GCAL_TASKS:2500,EVENTS_DIVIDER:" | "},r={todayTicktickAddedTasks:{key:"todayTicktickAddedTasks",schema:{}},todayTicktickUpdateTasks:{key:"todayTicktickUpdateTasks",schema:{}},todayTicktickCompletedTasks:{key:"todayTicktickCompletedTasks",schema:{}},todayGithubAddedCommits:{key:"todayGithubAddedCommits",schema:{}},todayGithubDeletedCommits:{key:"todayGithubDeletedCommits",schema:{}},lastReleasedVersionAlerted:{key:"lastReleasedVersionAlerted",schema:{}},lastDailyEmailSentDate:{key:"lastDailyEmailSentDate",schema:{}},githubLastAddedCommits:{key:"githubLastAddedCommits",schema:{}},githubLastDeletedCommits:{key:"githubLastDeletedCommits",schema:{}},githubCommitChangesCount:{key:"githubCommitChangesCount",schema:{}}},o={info:(e,...t)=>{console.log(e,...t)},error:(e,...t)=>{console.error(e,...t)}},a=()=>{var e;return null!==(e=Calendar.CalendarList.list({showHidden:!0}).items)&&void 0!==e?e:[]},c=e=>a().find((t=>t.summary===e)),d=e=>{const t=Calendar;if(t.CalendarList.list({showHidden:!0}).items.filter((e=>"owner"===e.accessRole)).map((e=>e.summary)).includes(e))throw new Error(`calendar ${e} already exists!`);const i=t.newCalendar();i.summary=e,i.timeZone=t.Settings.get("timezone").value;return t.Calendars.insert(i)};function l(e){return a().find((t=>t.summary===e))}function u(e){return e.reduce(((e,t)=>{const i=function(e){return Calendar.Events.list(e.id,{maxResults:s.MAX_GCAL_TASKS}).items.map((e=>function(e){var t,i,n,s,r;return{id:e.id,summary:e.summary,description:null!==(t=e.description)&&void 0!==t?t:"",htmlLink:e.htmlLink,attendees:null!==(i=e.attendees)&&void 0!==i?i:[],reminders:null!==(n=e.reminders)&&void 0!==n?n:{},visibility:null!==(s=e.visibility)&&void 0!==s?s:"default",start:e.start,end:e.end,created:e.created,updated:e.updated,colorId:e.colorId,extendedProperties:null!==(r=e.extendedProperties)&&void 0!==r?r:{}}}(e)))}(l(t));return[...e,...i]}),[])}function m(e,t){try{return Calendar.Events.insert(t,e.id)}catch(e){return o.info(`error when adding event [${t.summary}] to gcal: ${e.message}`),t}}function p(e,t,i){!function(e,t){try{Calendar.Events.remove(e.id,t.id)}catch(e){o.info(`error when deleting event [${t.summary}] to gcal: ${e.message}`)}}(e,i),Utilities.sleep(2e3);return m(t,i)}const g="gcal-sync",f="2.0.0",h="lucasvtiradentes/gcal-sync",y="ticktick_sync",k="github_sync",v={productionOnly:"This method cannot run in non-production environments",incorrectIcsCalendar:"The link you provided is not a valid ICS calendar: ",mustSpecifyConfig:"You must specify the settings when starting the class",httpsError:"You provided an invalid ICS calendar link: ",invalidGithubToken:"You provided an invalid github token",invalidGithubUsername:"You provided an invalid github username",abusiveGoogleCalendarApiUse:"Due to the numerous operations in the last few hours, the google api is not responding."};function T(t){return e(this,void 0,void 0,(function*(){t[k].commits_configs&&(yield function(t,i){var n;return e(this,void 0,void 0,(function*(){const e=[];let s=1,r=!1;for(;!1===r;){const o=`https://api.github.com/search/commits?q=author:${t}&page=${s}&sort=committer-date&per_page=100`;let a;a=""!==i?UrlFetchApp.fetch(o,{muteHttpExceptions:!0,headers:{Authorization:`Bearer ${i}`}}):UrlFetchApp.fetch(o,{muteHttpExceptions:!0});const c=null!==(n=JSON.parse(a.getContentText()))&&void 0!==n?n:{};if(200!==a.getResponseCode()){if("Validation Failed"===c.message)throw new Error(v.invalidGithubUsername);if("Bad credentials"===c.message)throw new Error(v.invalidGithubToken);throw new Error(c.message)}const d=c.items;if(0===d.length){r=!0;break}if(e.push(...d),s++,s>10){r=!0;break}}return e.map((e=>({commitDate:e.commit.author.date,commitMessage:e.commit.message.split("\n")[0],commitId:e.html_url.split("commit/")[1],commitUrl:e.html_url,repository:e.repository.full_name,repositoryId:e.repository.id,repositoryName:e.repository.name,repositoryOwner:e.repository.owner.login,repositoryDescription:e.repository.description,isRepositoryPrivate:e.repository.private,isRepositoryFork:e.repository.fork})))}))}(t[k].username,t[k].personal_token))}))}function _(e){const t=e.split("T");return{year:t[0].substring(0,4),month:t[0].substring(4,6),day:t[0].substring(6,8),hours:t[1]?t[1].substring(0,2):"00",minutes:t[1]?t[1].substring(2,4):"00",seconds:t[1]?t[1].substring(4,6):"00"}}const b=(e,t,i)=>{const n=e.slice(e.search(t)).replace(t,"");return n.slice(0,n.search(i))},C=(t,i)=>e(void 0,void 0,void 0,(function*(){const e=t.replace("webcal://","https://"),n=UrlFetchApp.fetch(e,{validateHttpsCertificates:!1,muteHttpExceptions:!0}),s=n.getContentText()||"";if(200!==n.getResponseCode())throw new Error(v.httpsError+e);if(-1===s.search("BEGIN:VCALENDAR"))throw new Error("RESPOSTA INVALIDA PRA UM ICS");const r=s.split("BEGIN:VEVENT\r\n").filter((e=>e.search("SUMMARY")>-1)),o=(s.search("SUMMARY:No task.")>0?[]:r.reduce(((e,t)=>{const i=t.split("BEGIN:VALARM\r\n");return[...e,{CALNAME:b(s,"X-WR-CALNAME:","\r\n"),DSTAMP:b(t,"DTSTAMP:","\r\n"),DTSTART:b(t,"DTSTART;","\r\n"),DTEND:b(t,"DTEND;","\r\n"),SUMMARY:b(t,"SUMMARY:","\r\n"),UID:b(t,"UID:","\r\n"),DESCRIPTION:b(t,"DESCRIPTION:","\r\n"),SEQUENCE:b(t,"SEQUENCE:","\r\n"),TZID:b(t,"TZID:","\r\n"),ALARM_TRIGGER:1===i.length?"":b(i[1],"TRIGGER:","\r\n"),ALARM_ACTION:1===i.length?"":b(i[1],"ACTION:","\r\n"),ALARM_DESCRIPTION:1===i.length?"":b(i[1],"DESCRIPTION:","\r\n")}]}),[])).map((e=>{const t=function(e,t,i,n){let s=e,r=t;if(s=s.slice(s.search(":")+1),r=r.slice(r.search(":")+1),""===r){const e=_(s),t=new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0));t.setDate(t.getDate()+1),r={date:t.toISOString().split("T")[0]},s={date:`${e.year}-${e.month}-${e.day}`}}else{const e=_(s),t=_(r),o=(e=>0===e?"":`${e<0?"-":"+"}${String(Math.abs(e)).padStart(2,"0")}:00`)(n);s={dateTime:`${e.year}-${e.month}-${e.day}T${e.hours}:${e.minutes}:${e.seconds}${o}`,timeZone:i},r={dateTime:`${t.year}-${t.month}-${t.day}T${t.hours}:${t.minutes}:${t.seconds}${o}`,timeZone:i}}return{finalDtstart:s,finalDtend:r}}(e.DTSTART,e.DTEND,e.TZID,i);return{id:e.UID,name:e.SUMMARY,description:e.DESCRIPTION,tzid:e.TZID,start:t.finalDtstart,end:t.finalDtend}}));return o}));const S=e=>e.reduce(((e,t)=>e.concat(t)),[]);function A(t){return e(this,void 0,void 0,(function*(){const i=t[y].ics_calendars,n={ticktickTasks:yield w(i,t.settings.timezone_correction),ticktickGcalTasks:u([...new Set(i.map((e=>e.gcal)))])};console.log({info:n});const s=Object.assign(Object.assign({},yield function({ticktickGcalTasks:t,ticktickTasks:i}){return e(this,void 0,void 0,(function*(){const e={added_tasks:[],updated_tasks:[]};for(const n of i){const i=t.find((e=>e.extendedProperties.private.tickTaskId===n.id)),s=l(n.gcal);if(i){const t=s.summary!==i.extendedProperties.private.calendar,r=yield I(n,i),o=l(n.gcal_done);(t||r.length>0)&&e.updated_tasks.push(p(s,o,Object.assign(Object.assign({},i),{colorId:void 0})))}else e.added_tasks.push(yield D(s,n))}return e}))}(n)),yield function({ticktickGcalTasks:t,ticktickTasks:i}){return e(this,void 0,void 0,(function*(){const e={completed_tasks:[]},n=t.filter((e=>{var t,i;return null===(i=null===(t=e.extendedProperties)||void 0===t?void 0:t.private)||void 0===i?void 0:i.tickTaskId}));for(const t of n){if(!i.map((e=>e.id)).includes(t.extendedProperties.private.tickTaskId)){const i=p(l(t.extendedProperties.private.calendar),l(t.extendedProperties.private.completedCalendar),Object.assign(Object.assign({},t),{colorId:void 0}));e.completed_tasks.push(i)}}return e}))}(n));console.log({resultInfo:s})}))}const E=e=>{let t=e;return t=t.replace(/\\,/g,","),t=t.replace(/\\;/g,";"),t=t.replace(/\\"/g,'"'),t=t.replace(/\\\\/g,"\\"),t};function D(t,i){return e(this,void 0,void 0,(function*(){const n=yield function(t){return e(this,void 0,void 0,(function*(){const e={private:{calendar:t.gcal,completedCalendar:t.gcal_done,tickTaskId:t.id}},i=(null==t?void 0:t.color)?{colorId:t.color.toString()}:{};var n;return Object.assign({summary:E(t.name),description:(n=t,`task: https://ticktick.com/webapp/#q/all/tasks/${n.id.split("@")[0]}${n.description?"\n\n"+n.description.replace(/\\n/g,"\n"):""}`),start:t.start,end:t.end,reminders:{useDefault:!0},extendedProperties:e},i)}))}(i);try{return m(t,n)}catch(e){throw e.message.search("API call to calendar.events.insert failed with error: Required")>-1?new Error(v.abusiveGoogleCalendarApiUse):new Error(e.message)}}))}function I(t,i){return e(this,void 0,void 0,(function*(){return[{hasChanged:E(t.name)!==i.summary,field:"name"},{hasChanged:Object.keys(t.start).length!==Object.keys(i.start).length,field:"date format"},{hasChanged:t.start.date!==i.start.date||t.start.dateTime!==i.start.dateTime,field:"initial date"},{hasChanged:t.end.date!==i.end.date||t.end.dateTime!==i.end.dateTime,field:"final date"},{hasChanged:(()=>{let e=!1;return e=void 0===(null==t?void 0:t.color)?void 0!==i.colorId:t.color.toString()!==i.colorId,e})(),field:"color"}].filter((e=>e.hasChanged)).map((e=>e.field))}))}function $(t,i){return e(this,void 0,void 0,(function*(){return S(yield Promise.all(t.map((t=>e(this,void 0,void 0,(function*(){return(yield C(t.link,i)).map((e=>Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},e),{gcal:t.gcal,gcal_done:t.gcal_done}),t.color?{color:t.color}:{}),t.tag?{tag:t.tag}:{}),t.ignoredTags?{ignoredTags:t.ignoredTags}:{})))}))))))}))}function w(t,i){return e(this,void 0,void 0,(function*(){const e=yield $(t.filter((e=>e.tag)),i),n=(yield $(t.filter((e=>e.ignoredTags)),i)).filter((t=>{const i=e.map((e=>`${e.tag}${e.id}`));return!1===t.ignoredTags.some((e=>i.includes(`${e}${t.id}`)))})),s=yield $(t.filter((e=>!e.tag&&!e.ignoredTags)),i);return[...e,...n,...s]}))}function R(e){return"object"==typeof e&&null!==e}function O(e,t){if(!R(e))return!1;for(const i in t){if(!(i in e))return o.error(`Missing key: ${i}`),!1;const n=typeof t[i],s=typeof e[i];if(R(t[i])){if(!R(e[i])||!O(e[i],t[i]))return o.error(`Invalid nested structure or type mismatch at key: ${i}`),!1}else if(n!==s)return o.error(`Type mismatch at key: ${i}. Expected ${n}, found ${s}`),!1}return!0}function P(e,t){return O(e,t)}const G={settings:{sync_function:"",timezone_correction:-3,update_frequency:4},options:{daily_summary_email_time:"15:00",email_daily_summary:!1,email_errors:!1,email_new_gcal_sync_release:!1,email_session:!1,maintenance_mode:!1,show_logs:!1}},N={ics_calendars:[]},U={username:"",commits_configs:{commits_calendar:"",ignored_repos:[],parse_commit_emojis:!1},issues_configs:{issues_calendar:""},personal_token:""};return class{constructor(e){if(this.configs=e,!function(e){if(!R(e))return!1;const t={basic:!0,ticktick:!0,github:!0};return t.basic=P(e,G),y in e&&(t.ticktick=P(e[y],N)),k in e&&(t.github=P(e[k],U)),Object.values(t).every((e=>!0===e))}(e))throw new Error("schema invalid");this.is_gas_environment="undefined"!=typeof Calendar,this.today_date=function(e){const t=new Date;return t.setHours(t.getHours()+e),t}(this.configs.settings.timezone_correction).toISOString().split("T")[0],o.info(`${g} is running at version ${f}!`)}parseGcalVersion(e){return Number(e.replace("v","").split(".").join(""))}getLatestGcalSyncRelease(){var e;const t=UrlFetchApp.fetch(`https://api.github.com/repos/${h}/releases?per_page=1`),i=null!==(e=JSON.parse(t.getContentText())[0])&&void 0!==e?e:{};if(0!==Object.keys(i).length)return i}install(){return e(this,void 0,void 0,(function*(){var e,t;n(this.configs.settings.sync_function),e=this.configs.settings.sync_function,t=this.configs.settings.update_frequency,ScriptApp.newTrigger(e).timeBased().everyMinutes(t).create(),Object.keys(r).forEach((e=>{PropertiesService.getScriptProperties().getProperties().includes(e)||i(r[e].key,"")})),o.info(`${g} was set to run function "${this.configs.settings.sync_function}" every ${this.configs.settings.update_frequency} minutes`)}))}uninstall(){return e(this,void 0,void 0,(function*(){n(this.configs.settings.sync_function),Object.keys(r).forEach((e=>{var t;t=r[e].key,PropertiesService.getScriptProperties().deleteProperty(t)})),o.info(`${g} automation was removed from appscript!`)}))}clearTodayEvents(){i(r.todayGithubAddedCommits.key,""),i(r.todayGithubDeletedCommits.key,""),i(r.todayTicktickAddedTasks.key,""),i(r.todayTicktickCompletedTasks.key,""),i(r.todayTicktickUpdateTasks.key,""),o.info(`${this.today_date} stats were reseted!`)}getTodayEvents(){return{addedGithubCommits:t(r.todayGithubAddedCommits.key),addedTicktickTasks:t(r.todayTicktickAddedTasks.key),completedTicktickTasks:t(r.todayTicktickCompletedTasks.key),deletedGithubCommits:t(r.todayGithubDeletedCommits.key),updatedTicktickTasks:t(r.todayTicktickUpdateTasks.key)}}sync(){return e(this,void 0,void 0,(function*(){const e=this.configs[k],t=this.configs[y];if(!e&&!t)return void o.info("nothing to sync");(e=>{let t=!1;e.forEach((e=>{c(e)||(d(e),o.info(`created google calendar: [${e}]`),t=!0)})),t&&Utilities.sleep(2e3)})([...new Set([].concat(e?[this.configs[k].commits_configs.commits_calendar,this.configs[k].issues_configs.issues_calendar]:[]).concat(t?[...this.configs[y].ics_calendars.map((e=>e.gcal)),...this.configs[y].ics_calendars.map((e=>e.gcal_done))]:[]))]),t&&(yield A(this.configs)),e&&(yield T(this.configs))}))}}}));
