!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).GcalSync=t()}(this,(function(){"use strict";function e(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const t="You provided an invalid github token",n="You provided an invalid github username";function o(e){const t=e.split("T");return{year:t[0].substring(0,4),month:t[0].substring(4,6),day:t[0].substring(6,8),hours:t[1]?t[1].substring(0,2):"00",minutes:t[1]?t[1].substring(2,4):"00",seconds:t[1]?t[1].substring(4,6):"00"}}const s=(t,n)=>e(void 0,void 0,void 0,(function*(){const e=t.replace("webcal://","https://");console.log({parsedLink:e});const s=yield fetch(e);console.log({response:s});const r=yield s.text();if(console.log({data:r}),-1===r.search("BEGIN:VCALENDAR"))throw new Error("RESPOSTA INVALIDA PRA UM ICS");const c=r.split("BEGIN:VEVENT\r\n").filter((e=>e.search("SUMMARY")>-1)),a=r.search("SUMMARY:No task.")>0?[]:c.reduce(((e,t)=>{const n=t.split("BEGIN:VALARM\r\n");return[...e,{CALNAME:i(r,"X-WR-CALNAME:","\r\n"),DSTAMP:i(t,"DTSTAMP:","\r\n"),DTSTART:i(t,"DTSTART;","\r\n"),DTEND:i(t,"DTEND;","\r\n"),SUMMARY:i(t,"SUMMARY:","\r\n"),UID:i(t,"UID:","\r\n"),DESCRIPTION:i(t,"DESCRIPTION:","\r\n"),SEQUENCE:i(t,"SEQUENCE:","\r\n"),TZID:i(t,"TZID:","\r\n"),ALARM_TRIGGER:1===n.length?"":i(n[1],"TRIGGER:","\r\n"),ALARM_ACTION:1===n.length?"":i(n[1],"ACTION:","\r\n"),ALARM_DESCRIPTION:1===n.length?"":i(n[1],"DESCRIPTION:","\r\n")}]}),[]);console.log({allEventsArr:a});const l=a.map((e=>{const t=function(e,t,n,s){let i=e,r=t;if(i=i.slice(i.search(":")+1),r=r.slice(r.search(":")+1),""===r){const e=o(i),t=new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0));t.setDate(t.getDate()+1),r={date:t.toISOString().split("T")[0]},i={date:`${e.year}-${e.month}-${e.day}`}}else{const e=o(i),t=o(r),c=(e=>0===e?"":`${e<0?"-":"+"}${String(Math.abs(e)).padStart(2,"0")}:00`)(s);i={dateTime:`${e.year}-${e.month}-${e.day}T${e.hours}:${e.minutes}:${e.seconds}${c}`,timeZone:n},r={dateTime:`${t.year}-${t.month}-${t.day}T${t.hours}:${t.minutes}:${t.seconds}${c}`,timeZone:n}}return{finalDtstart:i,finalDtend:r}}(e.DTSTART,e.DTEND,e.TZID,n);return{id:e.UID,name:e.SUMMARY,description:e.DESCRIPTION,tzid:e.TZID,start:t.finalDtstart,end:t.finalDtend}}));return console.log({allEventsParsedArr:l}),l})),i=(e,t,n)=>{const o=e.slice(e.search(t)).replace(t,"");return o.slice(0,o.search(n))};const r="gcal-sync",c="2.0.0",a="ticktick_sync",l="github_sync";function u(e){return"object"==typeof e&&null!==e}const d={info:(e,...t)=>{console.log(e,...t)},error:(e,...t)=>{console.error(e,...t)}};function m(e,t){if(!u(e))return!1;for(const n in t){if(!(n in e))return d.error(`Missing key: ${n}`),!1;const o=typeof t[n],s=typeof e[n];if(u(t[n])){if(!u(e[n])||!m(e[n],t[n]))return d.error(`Invalid nested structure or type mismatch at key: ${n}`),!1}else if(o!==s)return d.error(`Type mismatch at key: ${n}. Expected ${o}, found ${s}`),!1}return!0}function f(e,t){return m(e,t)}const g={settings:{sync_function:"",timezone_correction:-3,update_frequency:4},options:{daily_summary_email_time:"15:00",email_daily_summary:!1,email_errors:!1,email_new_gcal_sync_release:!1,email_session:!1,maintenance_mode:!1,show_logs:!1}},h={ics_calendars:[]},p={username:"",commits_configs:{commits_calendar:"",ignored_repos:[],parse_commit_emojis:!1},issues_configs:{issues_calendar:""},personal_token:""};return class{constructor(e){if(this.configs=e,this.isGASEnvironment="undefined"!=typeof Calendar,!function(e){if(!u(e))return!1;const t={basic:!0,ticktick:!0,github:!0};return t.basic=f(e,g),a in e&&(t.ticktick=f(e[a],h)),l in e&&(t.github=f(e[l],p)),Object.values(t).every((e=>!0===e))}(e))throw new Error("schema invalid");this.today_date=function(e){const t=new Date;return t.setHours(t.getHours()+e),t}(this.configs.settings.timezone_correction).toISOString().split("T")[0],d.info(`${r} is running at version ${c}!`)}sync(){return e(this,void 0,void 0,(function*(){const o=this.configs[l],i=this.configs[a],r=[...new Set([].concat(o?[this.configs[l].commits_configs.commits_calendar,this.configs[l].issues_configs.issues_calendar]:[]).concat(i?[...this.configs[a].ics_calendars.map((e=>e.gcal)),...this.configs[a].ics_calendars.map((e=>e.dcal_done))]:[]))];console.log({allGoogleCalendars:r});const c=this.configs[a].ics_calendars.map((e=>e.link));console.log({allIcsLinks:c});for(const e of c){console.log({ics1:e});const t=yield s(e,this.configs.settings.timezone_correction);console.log({tasks:t})}const u=(yield Promise.all(c.map((t=>e(this,void 0,void 0,(function*(){console.log({ics:t});const e=yield s(t,this.configs.settings.timezone_correction);return console.log({tasks:e}),e})))))).reduce(((e,t)=>e.concat(t)),[]);console.log(u),console.log(1);const d=yield function(o,s){var i;return e(this,void 0,void 0,(function*(){const e=[];let r=1,c=!1;for(;!1===c;){const a=`https://api.github.com/search/commits?q=author:${o}&page=${r}&sort=committer-date&per_page=100`;let l;l=""!==s?yield fetch(a,{headers:{Authorization:`Bearer ${s}`}}):yield fetch(a),console.log(l);const u=null!==(i=JSON.parse(yield l.text()))&&void 0!==i?i:{};if(200!==l.status){if("Validation Failed"===u.message)throw new Error(n);if("Bad credentials"===u.message)throw new Error(t);throw new Error(u.message)}const d=u.items;if(0===d.length){c=!0;break}if(e.push(...d),r++,r>10){c=!0;break}}return e.map((e=>({commitDate:e.commit.author.date,commitMessage:e.commit.message.split("\n")[0],commitId:e.html_url.split("commit/")[1],commitUrl:e.html_url,repository:e.repository.full_name,repositoryId:e.repository.id,repositoryName:e.repository.name,repositoryOwner:e.repository.owner.login,repositoryDescription:e.repository.description,isRepositoryPrivate:e.repository.private,isRepositoryFork:e.repository.fork})))}))}(this.configs[l].username,this.configs[l].personal_token);console.log(3),console.log(d)}))}}}));
