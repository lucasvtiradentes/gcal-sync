name: 'node.js CI-CD'

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  HUSKY: 0

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repository
      uses: actions/checkout@v4

    - name: install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: setup node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'
        registry-url: 'https://registry.npmjs.org'

    - name: install dependencies
      run: pnpm install

    - name: build package
      run: pnpm run build

    - name: run tests
      run: pnpm run test

  release:
    needs: ci
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: checkout repository
      uses: actions/checkout@v4

    - name: install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: setup node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'
        registry-url: 'https://registry.npmjs.org'

    - name: install dependencies
      run: pnpm install

    - name: create release PR or publish
      uses: changesets/action@v1
      with:
        publish: pnpm run release
        title: 'chore: version packages'
        commit: 'chore: version packages'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
